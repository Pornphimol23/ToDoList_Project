<!-- tasks.html -->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>To-Do List</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
</head>

<body class="bg-light">
<div class="container py-5">
  <div class="row">
    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô -->
    <div class="col-lg-4">
      <div class="card shadow-sm p-3">
        <form id="createForm">
          <div class="mb-2">
            <label class="form-label">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label>
            <input class="form-control" name="title" required>
          </div>
          <div class="mb-2">
            <label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
            <textarea class="form-control" name="description" rows="3"></textarea>
          </div>
          <div class="mb-2">
            <label class="form-label">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label>
            <input type="date" class="form-control" name="due_date">
          </div>
          <div class="mb-2">
            <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
            <select class="form-select" name="status" id="statusSelect"></select>
          </div>
          <div class="mb-3">
            <label class="form-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label>
            <select class="form-select" name="priority" id="prioritySelect"></select>
          </div>
          <button class="btn btn-primary w-100">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </form>
        <div id="createMsg" class="mt-2"></div>
      </div>
    </div>

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô -->
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex gap-2 mb-3">
            <input class="form-control" id="q" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
            <select class="form-select w-auto" id="filterStatus"></select>
            <select class="form-select w-auto" id="filterPriority"></select>
            <button class="btn btn-outline-secondary" onclick="loadTasks()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead>
                <tr>
                  <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
                  <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</th>
                  <th>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editForm">
        <div class="modal-header">
          <h5 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id">
          <div class="mb-2">
            <label class="form-label">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label>
            <input class="form-control" name="title" required>
          </div>
          <div class="mb-2">
            <label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
            <textarea class="form-control" name="description" rows="3"></textarea>
          </div>
          <div class="mb-2">
            <label class="form-label">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label>
            <input type="date" class="form-control" name="due_date">
          </div>
          <div class="mb-2">
            <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
            <select class="form-select" name="status" id="editStatus"></select>
          </div>
          <div class="mb-2">
            <label class="form-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label>
            <select class="form-select" name="priority" id="editPriority"></select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- üîΩ Script ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const token = localStorage.getItem("token");
const role = localStorage.getItem("role");

// ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à token
if (!token) {
  alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
  window.location.href = "/login.html";
}

// ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à role (‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞ user ‡∏´‡∏£‡∏∑‡∏≠ super_admin)
if (role !== "user" && role !== "super_admin") {
  alert("‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
  window.location.href = "/login.html";
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô fetch JSON ‡∏û‡∏£‡πâ‡∏≠‡∏° header
async function fetchJSON(url, options = {}) {
  const res = await fetch(url, {
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token,
    },
    ...options,
  });
  if (!res.ok) throw new Error(await res.text() || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
  return res.json();
}

let statuses = [];
let priorities = [];

/* ==========================================================
   üìå ‡πÇ‡∏´‡∏•‡∏î meta (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
========================================================== */
async function loadMeta() {
  [statuses, priorities] = await Promise.all([
    fetch("/api/meta/statuses").then(r => r.json()),
    fetch("/api/meta/priorities").then(r => r.json()),
  ]);

  statusSelect.innerHTML = statuses.map(s => `<option value="${s}">${s}</option>`).join("");
  prioritySelect.innerHTML = priorities.map(p => `<option value="${p}">${p}</option>`).join("");

  filterStatus.innerHTML = `<option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>` +
    statuses.map(s => `<option value="${s}">${s}</option>`).join("");
  filterPriority.innerHTML = `<option value="">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>` +
    priorities.map(p => `<option value="${p}">${p}</option>`).join("");

  editStatus.innerHTML = statuses.map(s => `<option value="${s}">${s}</option>`).join("");
  editPriority.innerHTML = priorities.map(p => `<option value="${p}">${p}</option>`).join("");

  // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô super_admin ‚Üí ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô
  if (role === "super_admin") {
    const addTaskForm = document.getElementById("createForm");
    if (addTaskForm) {
      addTaskForm.closest(".card").style.display = "none";
    }
  }
}

/* ==========================================================
   üßæ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
========================================================== */
async function loadTasks() {
  const params = new URLSearchParams();
  if (q.value) params.set("q", q.value);
  if (filterStatus.value) params.set("status", filterStatus.value);
  if (filterPriority.value) params.set("priority", filterPriority.value);

  try {
    const list = await fetchJSON("/api/tasks?" + params.toString());

    // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á: ‡πÄ‡∏û‡∏¥‡πà‡∏° "‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô" ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Super Admin
    const thead = document.querySelector("thead tr");
    thead.innerHTML = role === "super_admin"
      ? `
        <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
        <th>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</th>
        <th>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</th>
        <th></th>
      `
      : `
        <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</th>
        <th>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</th>
        <th></th>
      `;

    // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    tbody.innerHTML = list.map(row => `
      <tr>
        <td>
          <div class="fw-semibold">${row.title}</div>
          <div class="small text-muted">${row.description || ""}</div>
        </td>

        ${role === "super_admin" ? `<td><span class="badge bg-light text-dark">${row.owner || "-"}</span></td>` : ""}

        <td><span class="badge bg-secondary text-uppercase">${row.status}</span></td>
        <td><span class="badge bg-info text-dark text-uppercase">${row.priority}</span></td>
        <td>${row.due_date ? new Date(row.due_date).toLocaleDateString('th-TH') : ''}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary me-1" onclick='editTask(${row.id})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="btn btn-sm btn-outline-danger" onclick='removeTask(${row.id})'>‡∏•‡∏ö</button>
        </td>
      </tr>`).join("");
  } catch (err) {
    alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + err.message);
  }
}

/* ==========================================================
   ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
========================================================== */
createForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  createMsg.innerHTML = "";
  const fd = new FormData(createForm);
  const payload = Object.fromEntries(fd.entries());

  try {
    await fetchJSON("/api/tasks", {
      method: "POST",
      body: JSON.stringify(payload),
    });
    createForm.reset();
    await loadTasks();
    createMsg.innerHTML = '<div class="alert alert-success">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</div>';
    setTimeout(() => (createMsg.innerHTML = ""), 2000);
  } catch (err) {
    createMsg.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
  }
});

/* ==========================================================
   ‚úèÔ∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô
========================================================== */
async function editTask(id) {
  try {
    const tasks = await fetchJSON("/api/tasks");
    const task = tasks.find(t => t.id === id);
    if (!task) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç");

    const form = document.getElementById("editForm");
    form.id.value = task.id;
    form.title.value = task.title;
    form.description.value = task.description || "";
    form.due_date.value = task.due_date ? task.due_date.split("T")[0] : "";
    form.status.value = task.status || "pending";
    form.priority.value = task.priority || "medium";

    new bootstrap.Modal(document.getElementById("editModal")).show();
  } catch (err) {
    alert("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
  }
}

/* ==========================================================
   üßæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô Modal
========================================================== */
editForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(editForm);
  const payload = Object.fromEntries(fd.entries());
  const id = payload.id;
  delete payload.id;

  try {
    await fetchJSON("/api/tasks/" + id, {
      method: "PUT",
      body: JSON.stringify(payload),
    });
    await loadTasks();
    bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
    alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
  } catch (err) {
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
  }
});

/* ==========================================================
   üóëÔ∏è ‡∏•‡∏ö‡∏á‡∏≤‡∏ô
========================================================== */
async function removeTask(id) {
  if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?")) return;
  try {
    await fetchJSON("/api/tasks/" + id, { method: "DELETE" });
    await loadTasks();
    alert("üóëÔ∏è ‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
  } catch (err) {
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
  }
}

/* ==========================================================
   üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
========================================================== */
q.addEventListener("input", () => {
  clearTimeout(window.searchTimeout);
  window.searchTimeout = setTimeout(() => loadTasks(), 400);
});

// ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
loadMeta().then(loadTasks);
</script>
</body>
</html>
