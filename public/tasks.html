<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>To-Do List</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="/styles.css">
</head>
<body class="bg-light">
<div class="container py-5">
<div class="row">
<div class="col-lg-4">
<div class="card shadow-sm p-3">
<form id="createForm">
  <div class="mb-2">
    <label class="form-label">หัวข้อ</label>
    <input class="form-control" name="title" required>
  </div>
  <div class="mb-2">
    <label class="form-label">รายละเอียด</label>
    <textarea class="form-control" name="description" rows="3"></textarea>
  </div>
  <div class="mb-2">
    <label class="form-label">กำหนดส่ง</label>
    <input type="date" class="form-control" name="due_date">
  </div>
  <div class="mb-2">
    <label class="form-label">สถานะ</label>
    <select class="form-select" name="status" id="statusSelect"></select>
  </div>
  <div class="mb-3">
    <label class="form-label">ความสำคัญ</label>
    <select class="form-select" name="priority" id="prioritySelect"></select>
  </div>
  <button class="btn btn-primary w-100">บันทึก</button>
</form>
<div id="createMsg" class="mt-2"></div>
</div>
</div>

<div class="col-lg-8">
<div class="card">
<div class="card-body">
<div class="d-flex gap-2 mb-3">
<input class="form-control" id="q" placeholder="ค้นหา...">
<select class="form-select w-auto" id="filterStatus"></select>
<select class="form-select w-auto" id="filterPriority"></select>
<button class="btn btn-outline-secondary" onclick="loadTasks()">ค้นหา</button>
</div>
<div class="table-responsive">
<table class="table table-hover align-middle">
<thead>
<tr>
<th>หัวข้อ</th>
<th>สถานะ</th>
<th>ความสำคัญ</th>
<th>กำหนดส่ง</th>
<th></th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>

<script>
const token = localStorage.getItem("token");
const role = localStorage.getItem("role");

//  ถ้าไม่มี token → เด้งกลับ login
if (!token) {
  alert("กรุณาเข้าสู่ระบบก่อน");
  window.location.href = "/login.html";
}

// ตรวจ role ให้เข้าได้ทั้ง user และ super_admin
if (role !== "user" && role !== "super_admin") {
  alert("สิทธิ์ไม่ถูกต้อง");
  window.location.href = "/login.html";
}

function logout() {
  localStorage.removeItem("token");
  localStorage.removeItem("role");
  window.location.href = "/login.html";
}

//  ฟังก์ชัน fetch JSON พร้อม header
async function fetchJSON(url, options = {}) {
  const res = await fetch(url, {
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token,
    },
    ...options,
  });
  if (!res.ok) {
    const text = await res.text();
    throw new Error(text || "เกิดข้อผิดพลาด");
  }
  return res.json();
}
//  โหลดค่าจาก meta เช่น สถานะและความสำคัญ
async function loadMeta() {
  const [statuses, priorities] = await Promise.all([
    fetch("/api/meta/statuses").then((r) => r.json()),
    fetch("/api/meta/priorities").then((r) => r.json()),
  ]);
  statusSelect.innerHTML = statuses
    .map((s) => `<option value="${s}">${s}</option>`)
    .join("");
  prioritySelect.innerHTML = priorities
    .map((p) => `<option value="${p}">${p}</option>`)
    .join("");

  filterStatus.innerHTML =
    `<option value="">สถานะทั้งหมด</option>` +
    statuses.map((s) => `<option value="${s}">${s}</option>`).join("");
  filterPriority.innerHTML =
    `<option value="">ความสำคัญทั้งหมด</option>` +
    priorities.map((p) => `<option value="${p}">${p}</option>`).join("");
}

// โหลดรายการงาน
async function loadTasks() {
  const params = new URLSearchParams();
  if (q.value) params.set("q", q.value);
  if (filterStatus.value) params.set("status", filterStatus.value);
  if (filterPriority.value) params.set("priority", filterPriority.value);

  try {
    const list = await fetchJSON("/api/tasks?" + params.toString());
    tbody.innerHTML = list
      .map(
        (row) => `
      <tr>
        <td>
          <div class="fw-semibold">${row.title}</div>
          <div class="small text-muted">${row.description || ""}</div>
        </td>
        <td><span class="badge bg-secondary text-uppercase">${row.status}</span></td>
        <td><span class="badge bg-info text-dark text-uppercase">${row.priority}</span></td>
        <td>${row.due_date ? new Date(row.due_date).toLocaleDateString('th-TH') : ''}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary me-1" onclick='editTask(${row.id})'>แก้ไข</button>
          <button class="btn btn-sm btn-outline-danger" onclick='removeTask(${row.id})'>ลบ</button>
        </td>
      </tr>`
      )
      .join("");
  } catch (err) {
    alert("โหลดข้อมูลงานล้มเหลว: " + err.message);
  }
}

//  เพิ่มงานใหม่
createForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  createMsg.innerHTML = "";
  const fd = new FormData(createForm);
  const payload = Object.fromEntries(fd.entries());

  try {
    await fetchJSON("/api/tasks", {
      method: "POST",
      body: JSON.stringify(payload),
    });
    createForm.reset();
    await loadTasks();
    createMsg.innerHTML = '<div class="alert alert-success">บันทึกแล้ว</div>';
  } catch (err) {
    createMsg.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
  }
});

// แก้ไขงาน
async function editTask(id) {
  const title = prompt("แก้ไขหัวข้อ:");
  if (title === null) return;
  try {
    await fetchJSON("/api/tasks/" + id, {
      method: "PUT",
      body: JSON.stringify({ title }),
    });
    await loadTasks();
  } catch (err) {
    alert(err.message);
  }
}

//  ลบงาน
async function removeTask(id) {
  if (!confirm("ต้องการลบงานนี้?")) return;
  try {
    await fetchJSON("/api/tasks/" + id, { method: "DELETE" });
    await loadTasks();
  } catch (err) {
    alert(err.message);
  }
}

//  โหลด meta แล้วค่อยโหลดงาน
loadMeta().then(loadTasks);
</script>

</body>
</html>
